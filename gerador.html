// Substitua a função convertToEmbed por esta versão melhorada:
function convertToEmbed(url) {
    if (!url) return null;
    
    // Google Drive (Vídeo e PDF)
    const driveMatch = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (driveMatch) {
        return `https://drive.google.com/file/d/${driveMatch[1]}/preview`;
    }
    
    // Google Forms (já deve ser link de incorporação)
    if (url.includes('docs.google.com/forms/')) {
        // Garante que é o link de embed
        if (url.includes('viewform?embedded=true')) {
            return url;
        } else if (url.includes('viewform')) {
            return url.replace('viewform', 'viewform?embedded=true');
        }
        return url;
    }
    
    return null;
}

// Na função generateHtml, substitua a parte das seções condicionais:
function generateHtml() {
    const title = document.getElementById('course-title').value.trim();
    const videoUrl = document.getElementById('video-link').value.trim();
    const pdfUrl = document.getElementById('pdf-link').value.trim();
    const formsUrl = document.getElementById('forms-link').value.trim();
    const courseDesc = document.getElementById('course-desc').value.trim();
    const outputTextarea = document.getElementById('output-html');
    
    // Validação básica
    if (!title) {
        alert('Por favor, insira um título para o curso.');
        return;
    }
    
    let sectionIndex = 1;
    let sectionsHtml = '';
    
    // 1. VÍDEO
    if (videoUrl) {
        const embedUrl = convertToEmbed(videoUrl);
        if (embedUrl) {
            sectionsHtml += `
        <div class="card collapsible-card">
            <div class="collapsible-header">
                <h2><i class="fa-solid fa-video"></i> ${sectionIndex}. Assista à Aula (Vídeo)</h2>
                <i class="fa-solid fa-chevron-down toggle-icon"></i>
            </div>
            <div class="collapsible-content">
                <div class="card-content" style="padding-top: 0;">
                    <div class="video-responsive">
                        <iframe src="${embedUrl}" 
                                frameborder="0" allowfullscreen
                                title="Vídeo da aula: ${title}">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>\n`;
            sectionIndex++;
        } else {
            alert('Link de vídeo inválido. Use um link do Google Drive.');
        }
    }
    
    // 2. PDF
    if (pdfUrl) {
        const embedUrl = convertToEmbed(pdfUrl);
        if (embedUrl) {
            sectionsHtml += `
        <div class="card collapsible-card">
            <div class="collapsible-header">
                <h2><i class="fa-solid fa-book-open"></i> ${sectionIndex}. Leia o Material de Apoio (PDF)</h2>
                <i class="fa-solid fa-chevron-down toggle-icon"></i>
            </div>
            <div class="collapsible-content">
                <div class="card-content" style="padding-top: 0;">
                    <div class="pdf-viewer-container">
                        <iframe src="${embedUrl}" 
                                frameborder="0"
                                title="Material de apoio: ${title}">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>\n`;
            sectionIndex++;
        } else {
            alert('Link de PDF inválido. Use um link do Google Drive.');
        }
    }
    
    // 3. FORMS
    if (formsUrl) {
        const embedUrl = convertToEmbed(formsUrl);
        if (embedUrl) {
            sectionsHtml += `
        <div class="card collapsible-card">
            <div class="collapsible-header">
                <h2><i class="fa-solid fa-list-check"></i> ${sectionIndex}. Complete o Teste Rápido</h2>
                <i class="fa-solid fa-chevron-down toggle-icon"></i>
            </div>
            <div class="collapsible-content">
                <div class="card-content" style="padding-top: 0;">
                    <div class="form-responsive">
                        <iframe src="${embedUrl}" 
                                frameborder="0" marginheight="0" marginwidth="0"
                                title="Teste do curso: ${title}">
                            Carregando…
                        </iframe>
                    </div>
                </div>
            </div>
        </div>\n`;
            sectionIndex++;
        } else {
            alert('Link de formulário inválido. Use um link do Google Forms.');
        }
    }
    
    // Verifica se alguma seção foi gerada
    if (sectionsHtml === '') {
        outputTextarea.value = '';
        alert('Erro: Nenhuma URL de conteúdo válida foi fornecida. Por favor, preencha pelo menos um campo de link.');
        return;
    }

    // No CSS final, ajuste as alturas:
    const finalHtml = `
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinamento: ${title}</title>
    
    <meta name="robots" content="noindex">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* ESTILOS DE TREINAMENTO */
        :root {
            --primary-color: #1e3a5f;
            --link-color: #0056b3;
            --background-color: #f4f7f9;
            --card-background: #ffffff;
            --text-color: #333;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 900px; margin: auto; }
        .card { background-color: var(--card-background); border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
        .collapsible-header { padding: 25px 30px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .collapsible-header:hover { background-color: #f8f9fa; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; padding: 0 30px; }
        .collapsible-card.active .collapsible-content { max-height: 2000px; padding-bottom: 25px; }
        .toggle-icon { transition: transform 0.4s ease-out; }
        .collapsible-card.active .toggle-icon { transform: rotate(180deg); }
        .collapsible-header h2 { color: var(--primary-color); font-size: 1.5em; margin: 0; display: flex; align-items: center; }
        .collapsible-header h2 i { margin-right: 12px; }

        /* Estilos de Responsividade para IFRAMES - CORRIGIDOS */
        .video-responsive, .pdf-viewer-container, .form-responsive {
            position: relative;
            height: 0;
            overflow: hidden;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .video-responsive { 
            padding-bottom: 56.25%; /* 16:9 para vídeos */
        }
        .pdf-viewer-container { 
            padding-bottom: 130%; /* Altura mais adequada para PDFs */
            height: 600px; /* Altura fixa como fallback */
        }
        .form-responsive { 
            padding-bottom: 800px; /* Altura mais razoável para Forms */
            height: 600px; /* Altura fixa como fallback */
        }
        
        .video-responsive iframe, 
        .pdf-viewer-container iframe, 
        .form-responsive iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Fallback para quando o padding-bottom não funciona */
        @media (min-width: 768px) {
            .pdf-viewer-container,
            .form-responsive {
                height: 600px;
                padding-bottom: 0;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 style="text-align: center; margin-top: 20px; margin-bottom: 10px;">Treinamento: ${title}</h1>
        ${courseDesc ? `<p style="text-align: center; color: #666; margin-bottom: 30px; font-style: italic;">${courseDesc}</p>` : ''}

        ${sectionsHtml}

    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
            collapsibleHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    this.parentElement.classList.toggle('active');
                });
            });
            
            // Ativa a primeira seção por padrão
            const firstCard = document.querySelector('.collapsible-card');
            if (firstCard) {
                firstCard.classList.add('active');
            }
        });
    </script>
</body>
</html>
`;
    outputTextarea.value = finalHtml.trim();
    outputTextarea.select();
    alert(`Código HTML para "${title}" gerado com sucesso! Copie o código da caixa de texto.`);
}
